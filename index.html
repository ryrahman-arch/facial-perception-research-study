<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facial Perception Research Study</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            background-color: #f8f9fa;
            color: #2c3e50;
            font-size: 18px;
            line-height: 1.6;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 40px;
            font-size: 32px;
            font-weight: 600;
        }
        
        h2 {
            color: #34495e;
            font-size: 26px;
            margin-bottom: 25px;
        }
        
        h3 {
            color: #2c3e50;
            font-size: 22px;
            margin: 25px 0 20px 0;
        }
        
        p {
            font-size: 18px;
            margin-bottom: 20px;
            color: #34495e;
        }
        
        .special-instruction {
            background-color: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 20px;
            margin: 25px 0;
            border-radius: 5px;
            font-weight: bold;
            font-size: 20px;
            color: #2c3e50;
        }
        
        ul {
            font-size: 18px;
            line-height: 1.8;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #ecf0f1;
            border-radius: 6px;
            margin: 25px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            transition: width 0.3s ease;
        }
        
        .question-container {
            text-align: center;
            padding: 30px 0;
        }
        
        .image-container {
            margin: 30px 0;
            padding: 30px;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            background-color: #fafafa;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .face-image {
            max-width: 100%;
            max-height: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .yes-no-scale {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            gap: 40px;
        }
        
        .rating-scale {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 35px 0;
            gap: 20px;
        }
        
        .rating-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        
        .rating-option:hover {
            background-color: #f8f9fa;
        }
        
        .rating-option input[type="radio"] {
            margin-bottom: 10px;
            transform: scale(1.4);
        }
        
        .rating-option label {
            font-size: 16px;
            color: #2c3e50;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #1f4e79);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.4);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(149, 165, 166, 0.6);
        }
        
        .btn:disabled {
            background: #bdc3c7 !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .demographics-form {
            display: grid;
            gap: 25px;
            margin: 30px 0;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 18px;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .completion-screen {
            text-align: center;
            padding: 50px 20px;
        }
        
        .completion-screen h2 {
            color: #27ae60;
            margin-bottom: 25px;
            font-size: 28px;
        }
        
        .data-export {
            margin-top: 35px;
            padding: 25px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .hidden {
            display: none;
        }
        
        .question-number {
            font-size: 22px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 25px;
        }
        
        .stimulus-info {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Facial Perception Research Study</h1>
        
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <!-- Welcome Screen -->
        <div id="welcomeScreen">
            <h2>Welcome</h2>
            <p>Thank you for participating in this research study on facial perception. You will be shown a series of faces and asked to answer two questions about each face.</p>
            
            <div class="special-instruction">
                As you view each image, please pay close attention to the area around the eyes and overall facial proportions.
            </div>
            
            <p><strong>Instructions:</strong></p>
            <ul>
                <li>You will see 40 face images</li>
                <li>For each face, answer both questions:
                    <ul>
                        <li>Is this face within the usual range of human appearance?</li>
                        <li>How aesthetically pleasing is this face?</li>
                    </ul>
                </li>
                <li>There are no right or wrong answers - go with your first impression</li>
                <li>The survey takes approximately 10-15 minutes</li>
            </ul>
            
            <p><strong>Please complete the brief demographic information below:</strong></p>
            
            <div class="demographics-form">
                <div class="form-group">
                    <label for="age">Age Range:</label>
                    <select id="age" required>
                        <option value="">Select...</option>
                        <option value="Under 18">Under 18</option>
                        <option value="18-24">18-24</option>
                        <option value="25-34">25-34</option>
                        <option value="35-44">35-44</option>
                        <option value="45-54">45-54</option>
                        <option value="55-64">55-64</option>
                        <option value="65+">65+</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="gender">Gender:</label>
                    <select id="gender" required>
                        <option value="">Select...</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Non-binary">Non-binary</option>
                        <option value="Prefer not to say">Prefer not to say</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="ethnicity">Ethnicity:</label>
                    <select id="ethnicity" required>
                        <option value="">Select...</option>
                        <option value="Asian">Asian</option>
                        <option value="Black">Black</option>
                        <option value="Hispanic/Latino">Hispanic/Latino</option>
                        <option value="White">White</option>
                        <option value="Mixed">Mixed</option>
                        <option value="Other">Other</option>
                        <option value="Prefer not to say">Prefer not to say</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="education">Education Level:</label>
                    <select id="education" required>
                        <option value="">Select...</option>
                        <option value="Some high school">Some high school</option>
                        <option value="High school diploma/GED">High school diploma/GED</option>
                        <option value="Some college">Some college</option>
                        <option value="Associate degree">Associate degree</option>
                        <option value="Bachelor's degree">Bachelor's degree</option>
                        <option value="Master's degree">Master's degree</option>
                        <option value="Doctoral degree">Doctoral degree</option>
                        <option value="Professional degree">Professional degree</option>
                        <option value="Prefer not to say">Prefer not to say</option>
                    </select>
                </div>
            </div>
            
            <div class="navigation">
                <div></div>
                <button class="btn btn-primary" onclick="startSurvey()">Begin Study</button>
            </div>
        </div>
        
        <!-- Question Screen -->
        <div id="questionScreen" class="hidden">
            <div class="question-number" id="questionNumber">Question 1 of 40</div>
            
            <div class="question-container">
                <div class="image-container">
                    <img id="currentImage" class="face-image" src="" alt="Face to rate">
                    <div class="stimulus-info" id="stimulusInfo"></div>
                </div>
                
                <h3>Is this face within the usual range of human appearance?</h3>
                
                <div class="yes-no-scale">
                    <div class="rating-option">
                        <input type="radio" id="appearance1" name="appearance" value="yes">
                        <label for="appearance1">Yes</label>
                    </div>
                    <div class="rating-option">
                        <input type="radio" id="appearance2" name="appearance" value="no">
                        <label for="appearance2">No</label>
                    </div>
                </div>
                
                <h3>How aesthetically pleasing is this face?</h3>
                
                <div class="rating-scale">
                    <div class="rating-option">
                        <input type="radio" id="aesthetic1" name="aesthetic" value="1">
                        <label for="aesthetic1">1<br>Not at all<br>pleasant</label>
                    </div>
                    <div class="rating-option">
                        <input type="radio" id="aesthetic2" name="aesthetic" value="2">
                        <label for="aesthetic2">2<br>Slightly<br>unpleasant</label>
                    </div>
                    <div class="rating-option">
                        <input type="radio" id="aesthetic3" name="aesthetic" value="3">
                        <label for="aesthetic3">3<br>Neutral</label>
                    </div>
                    <div class="rating-option">
                        <input type="radio" id="aesthetic4" name="aesthetic" value="4">
                        <label for="aesthetic4">4<br>Quite<br>pleasant</label>
                    </div>
                    <div class="rating-option">
                        <input type="radio" id="aesthetic5" name="aesthetic" value="5">
                        <label for="aesthetic5">5<br>Very<br>pleasant</label>
                    </div>
                </div>
            </div>
            
            <div class="navigation">
                <button class="btn btn-secondary" onclick="previousQuestion()" id="prevBtn">Previous</button>
                <button class="btn btn-primary" onclick="nextQuestion()" id="nextBtn" disabled>Next</button>
            </div>
        </div>
        
        <!-- Completion Screen -->
        <div id="completionScreen" class="hidden">
            <div class="completion-screen">
                <h2>Thank you for completing the survey!</h2>
                <p>Your responses have been recorded. The study investigates how people perceive facial features across different demographic groups.</p>
                
                <div class="data-export">
                    <h3>Data Submission:</h3>
                    <p>Your responses have been automatically saved. You can also download a copy for your records:</p>
                    <button class="btn btn-primary" onclick="exportData()">Download My Data (Optional)</button>
                    <div id="submissionStatus" style="margin-top: 15px; font-weight: bold;"></div>
                </div>
            </div>
        </div>
        
        <!-- Hidden form for Netlify Forms data collection -->
        <form name="survey-responses" netlify netlify-honeypot="bot-field" hidden>
            <input type="hidden" name="form-name" value="survey-responses" />
            <input type="text" name="participantID" />
            <input type="text" name="ageRange" />
            <input type="text" name="gender" />
            <input type="text" name="ethnicity" />
            <input type="text" name="education" />
            <input type="text" name="responseData" />
        </form>
    </div>

    <script>
        // Survey configuration
        const DEMOGRAPHICS = {
            'AF': ['CFD-AF-240-206-N', 'CFD-AF-218-157-N'],
            'AM': ['CFD-AM-235-241-N', 'CFD-AM-226-234-N'],
            'BF': ['CFD-BF-249-091-N', 'CFD-BF-216-132-N'],
            'BM': ['CFD-BM-239-136-N', 'CFD-BM-243-218-N'],
            'LF': ['CFD-LF-237-190-N', 'CFD-LF-250-169-N'],
            'LM': ['CFD-LM-219-295-N', 'CFD-LM-234-176-N'],
            'WF': ['CFD-WF-233-112-N', 'CFD-WF-245-084-N'],
            'WM': ['CFD-WM-249-239-N', 'CFD-WM-203-023-N']
        };
        
        const VERSIONS = ['-10%', '-20%', '-30%', '-40%', '+10%', '+20%', '+30%', '+40%', 'MIN', 'PERFECT'];
        
        // Survey state
        let currentQuestion = 0;
        let surveyData = [];
        let stimulusSequence = [];
        let participantID = 'P' + Date.now();
        
        // Initialize survey
        function initializeSurvey() {
            generateStimulusSequence();
            updateProgress();
        }
        
        // Generate the randomized stimulus sequence
        function generateStimulusSequence() {
            stimulusSequence = [];
            
            // Step 1: Randomly select 1 person per demographic
            const selectedPeople = {};
            for (const [demographic, people] of Object.entries(DEMOGRAPHICS)) {
                selectedPeople[demographic] = people[Math.floor(Math.random() * people.length)];
            }
            
            // Step 2: For each selected person, randomly select 5 versions
            for (const [demographic, person] of Object.entries(selectedPeople)) {
                const selectedVersions = shuffleArray([...VERSIONS]).slice(0, 5);
                
                for (const version of selectedVersions) {
                    stimulusSequence.push({
                        demographic: demographic,
                        person: person,
                        version: version,
                        stimulus: `${person} ${version}`,
                        imagePath: `./${person}/${person} ${version}.png`
                    });
                }
            }
            
            // Step 3: Randomize the presentation order
            stimulusSequence = shuffleArray(stimulusSequence);
            
            console.log('Generated stimulus sequence:', stimulusSequence);
        }
        
        // Utility function to shuffle array
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // Start the survey
        function startSurvey() {
            // Validate demographics
            const ageRange = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;
            const ethnicity = document.getElementById('ethnicity').value;
            const education = document.getElementById('education').value;
            
            if (!ageRange || !gender || !ethnicity || !education) {
                alert('Please complete all demographic information before starting.');
                return;
            }
            
            // Store demographic data
            surveyData.push({
                participantID: participantID,
                ageRange: ageRange,
                gender: gender,
                ethnicity: ethnicity,
                education: education,
                timestamp: new Date().toISOString()
            });
            
            // Show first question
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('questionScreen').classList.remove('hidden');
            
            showQuestion();
        }
        
        // Show current question
        function showQuestion() {
            const stimulus = stimulusSequence[currentQuestion];
            
            // Update question number
            document.getElementById('questionNumber').textContent = `Question ${currentQuestion + 1} of ${stimulusSequence.length}`;
            
            // Update image with actual image path
            const imagePath = stimulus.imagePath;
            console.log('Trying to load image:', imagePath);
            
            document.getElementById('currentImage').src = imagePath;
            document.getElementById('currentImage').alt = `Face image: ${stimulus.stimulus}`;
            
            // Add error handler to detect loading issues
            document.getElementById('currentImage').onerror = function() {
                console.error('Failed to load image:', imagePath);
                console.log('Current working directory:', window.location.href);
                console.log('Expected full path:', new URL(imagePath, window.location.href).href);
            };
            
            document.getElementById('currentImage').onload = function() {
                console.log('Successfully loaded image:', imagePath);
            };
            
            // Clear previous ratings
            document.querySelectorAll('input[name="appearance"]').forEach(radio => {
                radio.checked = false;
            });
            document.querySelectorAll('input[name="aesthetic"]').forEach(radio => {
                radio.checked = false;
            });
            
            // Update button states
            document.getElementById('prevBtn').disabled = currentQuestion === 0;
            document.getElementById('nextBtn').disabled = true;
            
            // Add rating change listener
            function checkBothQuestionsAnswered() {
                const appearanceAnswered = document.querySelector('input[name="appearance"]:checked');
                const aestheticAnswered = document.querySelector('input[name="aesthetic"]:checked');
                document.getElementById('nextBtn').disabled = !(appearanceAnswered && aestheticAnswered);
            }
            
            document.querySelectorAll('input[name="appearance"]').forEach(radio => {
                radio.addEventListener('change', checkBothQuestionsAnswered);
            });
            
            document.querySelectorAll('input[name="aesthetic"]').forEach(radio => {
                radio.addEventListener('change', checkBothQuestionsAnswered);
            });
            
            updateProgress();
        }
        
        // Handle next question
        function nextQuestion() {
            // Save responses
            const appearanceRating = document.querySelector('input[name="appearance"]:checked');
            const aestheticRating = document.querySelector('input[name="aesthetic"]:checked');
            
            if (!appearanceRating || !aestheticRating) {
                alert('Please answer both questions before continuing.');
                return;
            }
            
            const stimulus = stimulusSequence[currentQuestion];
            surveyData.push({
                participantID: participantID,
                questionNumber: currentQuestion + 1,
                demographic: stimulus.demographic,
                person: stimulus.person,
                version: stimulus.version,
                stimulus: stimulus.stimulus,
                appearance_rating: appearanceRating.value,
                aesthetic_rating: parseInt(aestheticRating.value),
                responseTime: Date.now(),
                timestamp: new Date().toISOString()
            });
            
            // Move to next question or complete
            currentQuestion++;
            if (currentQuestion < stimulusSequence.length) {
                showQuestion();
            } else {
                completeSurvey();
            }
        }
        
        // Handle previous question
        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                showQuestion();
            }
        }
        
        // Complete survey
        function completeSurvey() {
            document.getElementById('questionScreen').classList.add('hidden');
            document.getElementById('completionScreen').classList.remove('hidden');
            updateProgress();
            
            // Automatically submit data
            submitDataAutomatically();
        }
        
        // Submit data automatically to Netlify Forms
        function submitDataAutomatically() {
            // Get demographic data
            const demographics = surveyData[0];
            
            // Prepare all response data as JSON string
            const allResponseData = JSON.stringify(surveyData);
            
            // Create form data
            const formData = new FormData();
            formData.append('form-name', 'survey-responses');
            formData.append('participantID', participantID);
            formData.append('ageRange', demographics.ageRange);
            formData.append('gender', demographics.gender);
            formData.append('ethnicity', demographics.ethnicity);
            formData.append('education', demographics.education);
            formData.append('responseData', allResponseData);
            
            // Submit to Netlify Forms
            fetch('/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById('submissionStatus').innerHTML = 
                        '<span style="color: #27ae60;">✓ Your responses have been submitted successfully!</span>';
                } else {
                    throw new Error('Network response was not ok');
                }
            })
            .catch(error => {
                console.error('Submission error:', error);
                document.getElementById('submissionStatus').innerHTML = 
                    '<span style="color: #e74c3c;">⚠ Submission failed. Please download and email your data using the button below.</span>';
            });
        }
        
        // Update progress bar
        function updateProgress() {
            const progress = ((currentQuestion + 1) / (stimulusSequence.length + 1)) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }
        
        // Export data as CSV
        function exportData() {
            const csv = convertToCSV(surveyData);
            downloadCSV(csv, `facial_perception_data_${participantID}.csv`);
        }
        
        // Convert data to CSV
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => 
                    JSON.stringify(row[header] || '')
                ).join(','))
            ].join('\n');
            
            return csvContent;
        }
        
        // Download CSV file
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSurvey();
        });
    </script>
</body>
</html>
